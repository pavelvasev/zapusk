Специальные шаги
================

Каждый шаг в zapusk имеет тип. Например:
```
################# my-component
[info]
...
[os]
...
```
В этой компоненте определены 2 шага - один с типом info, другой с типом os.

Тип шага определяет, что должно происходить:
* Если это специальный тип, то происходит реакция согласно описанию ниже.
* В других случаях считается что это идентификатор запуск-программы,
описанной в каталогах lib. Это называется **zdb-тип**.

[Код специальных шагов в zapusk-tool](https://github.com/pavelvasev/zapusk-tool/tree/master/src.v1/types)

## os
Предназначение: выполнить команду shell операционной системы

Пример:
```
################# params
somedir=alfa 15

################# my-component
[os]
apply=mkdir -p {{somedir}}
destroy=rm {{somedir}}
fill=echo 123>{{somedir}}/file.txt
```

Результат: 
* При прохождении команды **apply** будет вызвана команда shell **mkdir -p alfa-15**.
* При прохождении команды destroy будет вызвана команда shell **rm alfa-15**
* При прохождении команды fill будет вызвана команда **echo 123>{{somedir}}/file.txt**
* При прохождении других команд ничего сделано не будет.

После выполнения **[os]** не передает управление следующим шагам -- компонента завершает свою работу.

Примечания:
* Если команда вернула код возврата 100, это считается запросом остановить обработку следующих компонент в текущем zdb-типе.
* Если команда вернула ненулевой код возврата, это считается ошибкой, и выполнение всей запуск-программы останавливается.
* Можно указать особый параметр **default**, который означает получение всех команд.

Примечания zapusk-tool:
* Команда shell выполняется в текущем каталоге состояния.
* Если первое слово строчки shell совпадает с именем какого-нибудь файла в запуск-каталоге данной компоненты,
то оно будет заменено на полый путь к этому файлу.
* Командам shell передаются дополнительные переменные окружения: 
  * ZAPUSK_DEBUG - если действует режим отладки то "--debug" и пустая в противном случае.
  * ZAPUSK_PADDING - текущий отступ в строках вывода zapusk-tool 
  * ZAPUSK_DEFERRED_PATH - путь к файлу отложенных заданий.

## info
Предназначение: напечатать дополнительное пояснение

Пример:
```
################# my-component
[info]
system-update=Установка системного ПО
refresh=Обновление конфигурации
```
Результат: 
* при прохождении команды system-update будет напечано
сообщение **Установка системного ПО**. 
* При прохождении команды **refresh** будет напечатано **Обновление конфигурации**. 
* При прохождении других команд ничего напечатано не будет.

После обработки **[info]** передает управление следующему шагу.

## commands
Предназначение: преобразовать текущую команду в новые команды
и передать их последующим шагам.

Пример:
```
################# my-component
[commands]
apply=do1,do2
play=do2
destroy=remove-me

[os]
do1=echo doing 1
do2=echo doing 2
remove-me=echo destroying
```
Результат:
* При прохождении команды **apply** будут напечатаны строки **doing 1** и **doing 2**.
Это произойдет за счет того, что apply превратится в 2 вызова команд - **do1** и **do2**
* При прохождении команды **play** будет напечатана строка **doing 2**
* При прохождении команды **do1** ничего напечатано не будет. Потому что команда **do1**
не перечислена в шаге [commands]. Аналогично и для **do2**
* При прохождении команды **destroy** будет напечатана строка **destroying**.

Примечание
* Команда **destroy** проходит всегда, даже если не перечислена в **[commands]**.
* Можно не указывать значение параметра, тогда команда заменяется на команду **apply**.

Пример 2:
```
######################## my-component
[commands]
system-update

[os]
apply=ruby update-the-system.rb
destroy=ruby rollback.rb
```
Результат: 
* При прохождении команды **system-update** она будет заменена на apply, управление передано следующему узлу **[os]**,
и произойдет вызов **ruby update-the-system.rb**
* При прохождении команды **destroy** она будет передана без изменений узлу **[os]** и произойдет вызов **ruby rollback.rb**.

## once
Предназначение: сделать так, чтобы какая-то команда в контексте компонента выполнилась только 1 раз.

Пример:
```
##################### my-component
[commands]
apply=install-prerequisties,apply

[once]
install-prerequisties

[os]
install-prerequisties=apt-get install deboostrap guile
apply=perform-main-job.sh
```
Результат:
При прохождении команды **apply**:
1. шаг **[commands]** заменит ее на две команды **install-prerequisties** и **apply**,
2. шаг **[once]** при прохождении через него **install-prerequisties** произведет проверку, проходила
ли эта команда через него ранее. Если проходила - он не пропустит эту команду дальше.
Если команда еще не проходила - пропустит и сохранит отметку о прохождении, чтобы не пропускать
в дальнейшем.
3. шаг os будет выполнять те команды, которые в него придут.

Примечания.
* Команды, не перечисленные в **[once]**, передаются на следующий шаг без каких-либо проверок и изменений.
* Признак прохождения сохраняется в состоянии компоненты.
* Особый параметр **dir** позволяет поменять место хранения состояния. Таким образом можно делать once-проверки
общемашинного уровня.

Пример 2:
```
###################### my-component
[once]
update
dir=/var/zapusk-global-once/

...
```
Результат: какая бы запуск-программа не проходила через данную once-проверку, она будет использовать
общий каталог признаков. Таким образом, update в данном примере выполнится 1 раз на всей машине
и далее выполнятся не будет.

## file
Предназначение: записать файл с указанным содержимым в указанный путь.

Примечание:
* При прохождении любой команды, кроме **destroy**, шаг **[file]** будет записывать файл с указанным содержимым.
* При прохождении команды **destroy** шаг **[file]** удалит созданный им файл.
* При смене пути path созданный ранее файл будет удален.
* **ВАЖНО**: [file] не передает управление следующим шагам в текущем блоке.

Параметры:
* **path** - путь к файлу. Текущим каталогом является state_dir.
* **content** - содержимое файла.
* **mode** - права доступа к файлу. Можно использовать числа или символы.
Примеры: 755, +x, u=wrx,go=rx. Необязательный параметр.

Пример:
```
####################### some-component
[file]
path=/etc/nginx/snippets/my-snippet.conf
content="
 location /hello/ {
   return 408;
 }
"
####################### do-nginx-reload
[os]
apply=/etc/init.d/nginx reload
destroy=/etc/init.d/nginx reload
```

Результат примера:
* При прохождении команды **apply** будет создан файл **/etc/nginx/snippets/my-snippet.conf** и произведен вызов **/etc/init.d/nginx reload**
* При прохождении команды **destroy** будет удален файл **/etc/nginx/snippets/my-snippet.conf** и произведен вызов **/etc/init.d/nginx reload**

## guard

Предназначение: позволяет создать общий разделяемый ресурс, который не будет подвергнут destroy пока не исчезнут
все его запуск-пользователи (т.е. какие-либо развернутые компоненты запуск-программ). 

Пример:
```
####################### some-component
[guard]
key=some-key
dir=/var/zapusk-guards/

[os]
apply=echo applied
destroy=echo destroyed
```

Результат:
* При прохождении любой команды, будет сохранен признак того, что компонента global_name участвует в использовании области защиты (dir,key).
* При прохождении команды **destroy**, данный признак будет снят. Если в области защиты (dir,key) не остается других принаков,
то команда destroy будет пропущена к следующему за [guard] шагу.


## load

Предназначение: подключение zdb-подпрограммы из произвольной папки

Пример:
```
############################# my-program
[load]
dir=/some/path
alfa=5
beta=7
```

Результат: будет загружена запуск-программа из каталога /some/path с входными параметрами alfa=5 и beta=7
Все команды, поступающие в my-program, будут переданы в загруженную подпрограмму.

## when

Статуc: идея
Предназначение: пропускать команды только согласно расписанию

Пример:
```
############################## my-program
[when]
day_of_week=1 6 0

[os]
apply=echo Hello!
```

Результат: будет напечатан текст Hello! если сейчас понедельник, суббота или воскресение.

